FROM docker.io/trustgraph/trustgraph-ocr:1.4.23

ENV PIP_BREAK_SYSTEM_PACKAGES=1

WORKDIR /src

# Install runtime OS dependencies required by Spire libraries (ICU for .NET globalization)
RUN set -eux; \
    if command -v apt-get >/dev/null 2>&1; then \
        apt-get update && \
        apt-get install -y --no-install-recommends \
            libicu-dev && \
        rm -rf /var/lib/apt/lists/*; \
    elif command -v microdnf >/dev/null 2>&1; then \
        microdnf install -y \
            libicu && \
        microdnf clean all; \
    elif command -v dnf >/dev/null 2>&1; then \
        dnf install -y \
            libicu && \
        dnf clean all; \
    elif command -v yum >/dev/null 2>&1; then \
        yum install -y \
            libicu && \
        yum clean all; \
    elif command -v apk >/dev/null 2>&1; then \
        apk add --no-cache \
            icu-libs; \
    else \
        echo "No supported package manager found (apt-get/microdnf/dnf/yum/apk)"; \
        exit 1; \
    fi

# Install document processing libraries
# Spire.Doc for DOCX, python-pptx for PPTX (free, open-source)
RUN python -m pip install --no-cache-dir --upgrade pip && \
    python -m pip install --no-cache-dir Spire.Doc python-pptx Pillow

# Provide a fallback copy of the sources in case the container is
# started without bind-mounting the repository.
COPY trustgraph-base/ /src/trustgraph-base/
COPY trustgraph-ocr/ /src/trustgraph-ocr/

RUN python -m pip install --no-cache-dir --upgrade pip && \
    pip uninstall -y trustgraph-base trustgraph-ocr && \
    python -m pip install --no-cache-dir --no-deps \
        -e /src/trustgraph-base && \
    python -m pip install --no-cache-dir --no-deps \
        -e /src/trustgraph-ocr
