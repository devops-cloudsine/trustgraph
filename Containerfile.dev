FROM docker.io/trustgraph/trustgraph-flow:1.4.23

ENV PIP_BREAK_SYSTEM_PACKAGES=1

WORKDIR /src

# Install runtime OS dependencies required for image decoding (OpenCV/Pillow backends).
# Supports multiple base distros by detecting the package manager.
RUN set -eux; \
    if command -v apt-get >/dev/null 2>&1; then \
        apt-get update && \
        apt-get install -y --no-install-recommends \
            libgl1 \
            libglib2.0-0 \
            tesseract-ocr \
            libmagic1 && \
        rm -rf /var/lib/apt/lists/*; \
    elif command -v microdnf >/dev/null 2>&1; then \
        microdnf install -y \
            mesa-libGL \
            glib2 \
            tesseract \
            file && \
        microdnf clean all; \
    elif command -v dnf >/dev/null 2>&1; then \
        dnf install -y \
            mesa-libGL \
            glib2 \
            tesseract \
            file && \
        dnf clean all; \
    elif command -v yum >/dev/null 2>&1; then \
        yum install -y \
            mesa-libGL \
            glib2 \
            tesseract \
            file && \
        yum clean all; \
    elif command -v apk >/dev/null 2>&1; then \
        apk add --no-cache \
            mesa-gl \
            glib \
            tesseract-ocr \
            file; \
    else \
        echo "No supported package manager found (apt-get/microdnf/dnf/yum/apk)"; \
        exit 1; \
    fi

# Pre-install heavy Python deps that rarely change so Docker can cache the layer.
# This avoids pip installing them on every rebuild when source code changes.
RUN python -m pip install --no-cache-dir --upgrade pip && \
    python -m pip install --no-cache-dir "unstructured[all-docs]" pillow pytesseract Spire.PDF Spire.Doc requests asyncio && \
    python -m pip uninstall -y onnxruntime || true && \
    python -m pip install --no-cache-dir "onnxruntime-gpu>=1.17,<1.19"

# Provide a fallback copy of the sources in case the container is
# started without bind-mounting the repository.
COPY trustgraph-base/ /src/trustgraph-base/
COPY trustgraph-flow/ /src/trustgraph-flow/

RUN python -m pip install --no-cache-dir --upgrade pip && \
    pip uninstall -y trustgraph-base trustgraph-flow || true && \
    python -m pip install --no-cache-dir --no-deps \
        -e /src/trustgraph-base && \
    python -m pip install --no-cache-dir --no-deps \
        -e /src/trustgraph-flow

